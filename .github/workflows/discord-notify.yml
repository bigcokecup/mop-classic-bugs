name: Discord Notifications (Issues Only ‚Ä¢ Styled)

on:
  issues:
    types: [opened, closed]     # Ïù¥Ïäà Ïó¥Î¶º/Îã´Ìûò
  issue_comment:
    types: [created]            # Ïù¥ÏäàÏóê ÏÉà ÎåìÍ∏Ä
  workflow_dispatch: {}         # ÏàòÎèô ÌÖåÏä§Ìä∏

jobs:
  notify:
    runs-on: ubuntu-latest
    steps:
      - name: Install jq
        run: sudo apt-get update && sudo apt-get install -y jq

      - name: Send Issue/Comment Notification to Discord
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}
          GITHUB_EVENT_NAME: ${{ github.event_name }}
          GITHUB_EVENT_PATH: ${{ github.event_path }}
          ACTOR: ${{ github.actor }}
          REPO: ${{ github.repository }}
          RUN_URL: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
        run: |
          set -euo pipefail
          ts=$(date -u +"%Y-%m-%dT%H:%M:%SZ")

          # Í∏∞Î≥∏(ÎîîÌè¥Ìä∏) Í∞í
          color=8359053
          embed_title=""
          embed_desc=""
          embed_url=""
          author_name="$ACTOR"
          author_icon="https://github.githubassets.com/images/modules/logos_page/GitHub-Mark.png"
          labels_val=""
          action_text=""

          if [ "$GITHUB_EVENT_NAME" = "issues" ]; then
            action=$(jq -r '.action' "$GITHUB_EVENT_PATH")
            number=$(jq -r '.issue.number' "$GITHUB_EVENT_PATH")
            title=$(jq -r '.issue.title' "$GITHUB_EVENT_PATH")
            url=$(jq -r '.issue.html_url' "$GITHUB_EVENT_PATH")
            labels_val=$(jq -r '[.issue.labels[].name] | join(", ") // ""' "$GITHUB_EVENT_PATH")
            author_name=$(jq -r '.sender.login // ""' "$GITHUB_EVENT_PATH")
            author_icon=$(jq -r '.sender.avatar_url // ""' "$GITHUB_EVENT_PATH")

            # ÏÉâÏÉÅ: opened = Ï¥àÎ°ù / closed = Îπ®Í∞ï
            if [ "$action" = "closed" ]; then color=15158332; else color=3066993; fi

            embed_title="üìù Issue #$number: $title"
            embed_desc="**$author_name** $action issue in **$REPO**"
            embed_url="$url"
            action_text="$action"

          elif [ "$GITHUB_EVENT_NAME" = "issue_comment" ]; then
            number=$(jq -r '.issue.number' "$GITHUB_EVENT_PATH")
            title=$(jq -r '.issue.title' "$GITHUB_EVENT_PATH")
            url=$(jq -r '.comment.html_url' "$GITHUB_EVENT_PATH")
            body=$(jq -r '.comment.body // ""' "$GITHUB_EVENT_PATH")
            author_name=$(jq -r '.comment.user.login // .sender.login // ""' "$GITHUB_EVENT_PATH")
            author_icon=$(jq -r '.comment.user.avatar_url // .sender.avatar_url // ""' "$GITHUB_EVENT_PATH")

            # ÏΩîÎ©òÌä∏ Î≥∏Î¨∏ÏùÄ Ï°∞Í∏àÎßå (ÏûÑÎ≤†Îìú Ï†úÌïú ÎåÄÎπÑ)
            body=$(printf '%s' "$body" | head -c 700)
            # Ï§ÑÎ∞îÍøàÏùÄ Ïù∏Ïö© ÌòïÌÉúÎ°ú
            body="${body//$'\n'/$'\n> '}"

            color=9807270
            embed_title="üí¨ Comment on #$number: $title"
            embed_desc="> ${body}"
            embed_url="$url"
            action_text="commented"
          fi

          # ÎùºÎ≤® ÌïÑÎìú JSON Íµ¨ÏÑ±
          if [ -n "$labels_val" ]; then
            fields_json='[{"name":"Labels","value":"'"$labels_val"'","inline":true},{"name":"Action","value":"'"$action_text"'","inline":true},{"name":"Run","value":"'"$RUN_URL"'","inline":false}]'
          else
            fields_json='[{"name":"Action","value":"'"$action_text"'","inline":true},{"name":"Run","value":"'"$RUN_URL"'","inline":false}]'
          fi

          payload=$(jq -n \
            --arg username "GitHub Issues" \
            --arg t "$embed_title" \
            --arg d "$embed_desc" \
            --arg url "$embed_url" \
            --arg a "$author_name" \
            --arg icon "$author_icon" \
            --arg ts "$ts" \
            --arg footer "$REPO" \
            --argjson color $color \
            --argjson fields "$fields_json" \
            '{
              username: $username,
              allowed_mentions: { parse: [] },
              embeds: [
                {
                  title: $t,
                  description: $d,
                  url: $url,
                  color: $color,
                  author: { name: $a, icon_url: $icon },
                  timestamp: $ts,
                  footer: { text: $footer },
                  fields: $fields
                }
              ]
            }')

          curl -sS -H "Content-Type: application/json" -d "$payload" "$DISCORD_WEBHOOK"
