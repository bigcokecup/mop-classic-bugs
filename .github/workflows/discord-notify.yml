name: Discord Notifications (Issues Only)

on:
  issues:
    types: [opened, closed]     # ì´ìŠˆ ì—´ë¦¼/ë‹«íž˜
  issue_comment:
    types: [created]            # ì´ìŠˆì— ìƒˆ ëŒ“ê¸€
  workflow_dispatch: {}         # ìˆ˜ë™ í…ŒìŠ¤íŠ¸ìš©

jobs:
  notify:
    runs-on: ubuntu-latest
    steps:
      - name: Install jq
        run: sudo apt-get update && sudo apt-get install -y jq

      - name: Send Issue/Comment Notification to Discord
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}
          GITHUB_EVENT_NAME: ${{ github.event_name }}
          GITHUB_EVENT_PATH: ${{ github.event_path }}
          ACTOR: ${{ github.actor }}
          REPO: ${{ github.repository }}
          RUN_URL: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
        run: |
          set -euo pipefail
          ts=$(date -u +"%Y-%m-%dT%H:%M:%SZ")

          case "$GITHUB_EVENT_NAME" in
            issues)
              action=$(jq -r '.action' "$GITHUB_EVENT_PATH")
              number=$(jq -r '.issue.number' "$GITHUB_EVENT_PATH")
              title=$(jq -r '.issue.title' "$GITHUB_EVENT_PATH")
              url=$(jq -r '.issue.html_url' "$GITHUB_EVENT_PATH")

              # ìƒ‰ìƒ (opened=íŒŒëž‘, closed=ë¹¨ê°•)
              if [ "$action" = "closed" ]; then color=15158332; else color=3447003; fi

              embed_title="ðŸ“ Issue #$number: $title"
              embed_desc="**$ACTOR** $action issue in **$REPO**"
              embed_url="$url"
              ;;
            issue_comment)
              number=$(jq -r '.issue.number' "$GITHUB_EVENT_PATH")
              title=$(jq -r '.issue.title' "$GITHUB_EVENT_PATH")
              url=$(jq -r '.comment.html_url' "$GITHUB_EVENT_PATH")
              body=$(jq -r '.comment.body // ""' "$GITHUB_EVENT_PATH")

              # ì•ˆì „í•˜ê²Œ ë³¸ë¬¸ ê¸¸ì´ ì œí•œ (ë””ìŠ¤ì½”ë“œ ìž„ë² ë“œ ì œí•œ ê³ ë ¤)
              body=$(printf '%s' "$body" | head -c 700)

              color=9807270
              embed_title="ðŸ’¬ Comment on #$number: $title"
              embed_desc="**$ACTOR** commented:\n> ${body}"
              embed_url="$url"
              ;;
            *)
              color=8359053
              embed_title="$GITHUB_EVENT_NAME"
              embed_desc="Unhandled event"
              embed_url="https://github.com/$REPO"
              ;;
          esac

          payload=$(jq -n \
            --arg username "GitHub Issues" \
            --arg t "$embed_title" \
            --arg d "$embed_desc" \
            --arg url "$embed_url" \
            --arg ts "$ts" \
            --argjson color $color \
            '{
              username: $username,
              allowed_mentions: { parse: [] },
              embeds: [
                {
                  title: $t,
                  description: $d,
                  url: $url,
                  color: $color,
                  timestamp: $ts
                }
              ]
            }')

          curl -sS -H "Content-Type: application/json" -d "$payload" "$DISCORD_WEBHOOK"
