name: Discord Notifications (push / PR / issues / releases)
# test trigger

on:
  push:
    branches: ["**"]   # í•„ìš”í•œ ë¸Œëžœì¹˜ë§Œ ì›í•˜ë©´ ìˆ˜ì •
  pull_request:
    types: [opened, reopened, closed, ready_for_review, converted_to_draft]
  issues:
    types: [opened, reopened, closed]
  release:
    types: [published]
  workflow_dispatch: {}  # ìˆ˜ë™ í…ŒìŠ¤íŠ¸ìš©

jobs:
  notify:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout (for commit messages on push)
        if: ${{ github.event_name == 'push' }}
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

        # ë©”ì‹œì§€ ë§Œë“¤ê³  ë””ìŠ¤ì½”ë“œë¡œ ì „ì†¡
      - name: Build & Send Message to Discord
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}
          GITHUB_EVENT_NAME: ${{ github.event_name }}
          GITHUB_EVENT_PATH: ${{ github.event_path }}
          REPO: ${{ github.repository }}
          ACTOR: ${{ github.actor }}
          SHA: ${{ github.sha }}
          REF: ${{ github.ref }}
          RUN_URL: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
        run: |
          set -euo pipefail

          short_sha="${SHA:0:7}"
          ref_name="${REF#refs/heads/}"

          # ê¸°ë³¸ ìž„ë² ë“œ(ê³µí†µ)
          author_name="$ACTOR"
          repo_url="https://github.com/$REPO"
          ts=$(date -u +"%Y-%m-%dT%H:%M:%SZ")

          # ì´ë²¤íŠ¸ë³„ ë¶„ê¸°
          case "$GITHUB_EVENT_NAME" in
            push)
              # ìµœì‹  ì»¤ë°‹ ë©”ì‹œì§€ (ì—¬ëŸ¬ ì»¤ë°‹ì¼ ë•Œë„ ì²« ì¤„ ìœ„ì£¼)
              commit_msg="$(git log -1 --pretty=%B | head -c 4000)"
              commit_url="$repo_url/commit/$SHA"
              title="ðŸ“¦ Push to $ref_name"
              desc="**$ACTOR** pushed to \`$ref_name\` in **$REPO**\n\n**Commit** \`$short_sha\`\n${commit_msg}\n\n[View commit]($commit_url) â€¢ [Run]($RUN_URL)"
              color=5814783
              ;;
            pull_request)
              pr_title=$(jq -r '.pull_request.title' "$GITHUB_EVENT_PATH")
              pr_number=$(jq -r '.pull_request.number' "$GITHUB_EVENT_PATH")
              pr_url=$(jq -r '.pull_request.html_url' "$GITHUB_EVENT_PATH")
              pr_action=$(jq -r '.action' "$GITHUB_EVENT_PATH")
              merged=$(jq -r '.pull_request.merged' "$GITHUB_EVENT_PATH")
              title="ðŸ”€ PR #$pr_number: $pr_title"
              if [ "$pr_action" = "closed" ] && [ "$merged" = "true" ]; then
                status="**Merged**"
                color=3066993
              elif [ "$pr_action" = "closed" ]; then
                status="**Closed**"
                color=15158332
              elif [ "$pr_action" = "ready_for_review" ]; then
                status="**Ready for review**"
                color=3447003
              elif [ "$pr_action" = "converted_to_draft" ]; then
                status="**Draft**"
                color=9807270
              else
                status="**$pr_action**"
                color=15105570
              fi
              desc="**$ACTOR** $status PR in **$REPO**\n[View PR]($pr_url) â€¢ [Run]($RUN_URL)"
              ;;
            issues)
              is_title=$(jq -r '.issue.title' "$GITHUB_EVENT_PATH")
              is_number=$(jq -r '.issue.number' "$GITHUB_EVENT_PATH")
              is_url=$(jq -r '.issue.html_url' "$GITHUB_EVENT_PATH")
              is_action=$(jq -r '.action' "$GITHUB_EVENT_PATH")
              title="ðŸ“ Issue #$is_number: $is_title"
              case "$is_action" in
                opened) color=3447003 ;;
                reopened) color=15105570 ;;
                closed) color=15158332 ;;
                *) color=9807270 ;;
              esac
              desc="**$ACTOR** $is_action issue in **$REPO**\n[View Issue]($is_url) â€¢ [Run]($RUN_URL)"
              ;;
            release)
              rel_name=$(jq -r '.release.name // empty' "$GITHUB_EVENT_PATH")
              rel_tag=$(jq -r '.release.tag_name' "$GITHUB_EVENT_PATH")
              rel_url=$(jq -r '.release.html_url' "$GITHUB_EVENT_PATH")
              title="ðŸ·ï¸ Release $rel_tag"
              [ -n "$rel_name" ] && title="$title â€” $rel_name"
              desc="**$ACTOR** published a release in **$REPO**\n[View Release]($rel_url) â€¢ [Run]($RUN_URL)"
              color=15844367
              ;;
            *)
              title="ðŸ“£ $GITHUB_EVENT_NAME"
              desc="**$ACTOR** triggered **$GITHUB_EVENT_NAME** in **$REPO**\n[Run]($RUN_URL)"
              color=8359053
              ;;
          esac

          # ê¸¸ì´ ì•ˆì „ìž¥ì¹˜ (ë””ìŠ¤ì½”ë“œ ì œí•œ ê³ ë ¤)
          maxlen=5900
          desc_len=${#desc}
          if [ $desc_len -gt $maxlen ]; then
            desc="${desc:0:$maxlen}â€¦"
          fi

          # Discord embeds payload
          payload=$(jq -n \
            --arg username "GitHub" \
            --arg t "$title" \
            --arg d "$desc" \
            --arg a "$author_name" \
            --arg url "$repo_url" \
            --arg ts "$ts" \
            --argjson color $color \
            '{
              username: $username,
              embeds: [
                {
                  title: $t,
                  description: $d,
                  url: $url,
                  color: $color,
                  author: { name: $a },
                  timestamp: $ts
                }
              ]
            }')

          curl -sS -H "Content-Type: application/json" -d "$payload" "$DISCORD_WEBHOOK" >/dev/null

          echo "Sent $GITHUB_EVENT_NAME notification to Discord."
